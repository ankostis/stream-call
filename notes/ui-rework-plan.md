# Options UI Rework Plan

**Goal**: Make pattern editing easy for non-technical users, remove the need to edit raw JSON or escape strings, and add bulk import/export with overwrite-by-name semantics.

## UX Plan (3 key recommendations)
- **Form-Based Editor**: Simple form with fields for **Name**, **Method**, **Endpoint**, **Body Template**, **Headers (key/value rows)**, and **Include Page Info**. Live validation. No JSON required.
- **Minimal/Advanced Toggle**: Minimal mode shows only Name, Method, Endpoint. Advanced reveals Headers, Body Template, Include Page Info.
- **Preview + Validation**: “Preview Request” renders endpoint/body with sample context (streamUrl, pageTitle, timestamp) and shows human-readable validation errors.

## List & Inline Editing
- Patterns shown in a list with Name, Method, Endpoint summary. Buttons: **Edit**, **Delete**.
- Inline edit keeps users in context; modal is acceptable if simpler to implement.
- Preset templates (GET with query, POST JSON, httpbin) to bootstrap non-technical users.

## Import/Export (Bulk)
- **Export**: Button to download all patterns as a JSON file (array of objects). Filename suggestion: `stream-call-patterns.json`.
- **Import**: Button to select a JSON file, parse, validate, and **merge by Name**:
  - If a pattern with the same Name exists, **overwrite** it.
  - If Name is new, **append** it.
  - Names must be unique; prompt on conflicts if necessary.
- **Validation & Feedback**: Show summary — added N, updated M, skipped K, with per-item errors.
- **Format**: Use the same storage schema (Name, Method, Endpoint, Headers, Body Template, Include Page Info). No `id` required.

## Storage & Data Model
- Continue storing under `browser.storage.sync` key `apiPatterns` as a JSON array.
- **Primary key**: `name` (unique, user-defined). Drop autogenerated `id` for UI operations.
- Body Template is stored as plain string; users type naturally (no escaping). The editor provides examples and validation, storage remains JSON behind the scenes.

## Code Audit: `id` vs `name`
- `popup.ts`: Uses `id` for `<select>` option values and passes `patternId` in `CALL_API`.
- `background.ts`: Selects pattern via `patterns.find(p => p.id === patternId)`.
- `config.ts`: Autogenerates `id` in `parsePatterns()` and `validatePatterns()`.
- `options.ts`: Validates/normalizes patterns; currently generates `id`.

**Recommendation**: Use `name` as the unique identifier across the codebase.
- Update `popup.ts` to set `<option value=pattern.name>` and pass `patternName` in `CALL_API`.
- Update `background.ts` to select with `patterns.find(p => p.name === patternName)`.
- Update `config.ts` to stop generating `id`; enforce required `name` and uniqueness.
- Update `options.ts` validation to require `name`; show error if missing/duplicate.
- Migration: For existing stored patterns that include `id`, ignore `id` and derive uniqueness by `name`. If duplicates occur, keep the first and prompt the user to rename.

## Implementation Steps
- **Phase 1: Data model changes**
  - Update `config.ts` (`parsePatterns`, `validatePatterns`) to require unique `name`, drop `id` generation.
  - Add helper `mergePatternsByName(existing, imported)` to support bulk import.
- **Phase 2: Popup & Background alignment**
  - Change `popup.ts` select to key by `name` and send `patternName`.
  - Change `background.ts` `RuntimeMessage` to accept `patternName`; select by name.
- **Phase 3: Options UI**
  - Replace textarea with list + form (Minimal/Advanced, Headers rows, Body textarea).
  - Add **Export** (download JSON) and **Import** (merge-by-name) buttons with progress feedback.
  - Add **Preview** with templated endpoint/body.
- **Phase 4: Polish & Accessibility**
  - Inline validation messages, keyboard navigation, confirmation dialogs.

## Testing Plan
- **Unit**:
  - `parsePatterns()`: requires name, enforces uniqueness, no id generation.
  - `mergePatternsByName()`: add/overwrite semantics; report counts.
  - Form serialization/deserialization for options editor.
- **Integration**:
  - Options flow: add/edit/delete, preview, save → reload persists.
  - Import/export: export → import same file overwrites correctly by name.
- **Manual**: Checklist covering validation, preview, headers/body edge cases, storage persistence.

## Timeline (estimate)
- Data model + popup/background alignment: ~2 hours
- Options form + validation + preview: ~3 hours
- Import/export + merge logic: ~1.5 hours
- Tests + polish: ~1.5 hours
- **Total**: ~8 hours

## Notes
- Keep manifest and build unchanged; UI lives in [options.html](options.html) and logic in [src/options.ts](src/options.ts).
- Storage remains a JSON array to preserve sync behavior; editor abstracts it away for users.
